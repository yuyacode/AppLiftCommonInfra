AWSTemplateFormatVersion: '2010-09-09'
Description: >
  This CloudFormation template create IAM Roles that allow GitHub Actions to assume the role and deploy AWS resources securely.
  This single template can be expanded in the future to include multiple roles for various resource types.

Parameters:
  GitHubOIDCProviderArn:
    Type: String

Resources:
  NetworkResourceDeployRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: NetworkResourceDeployRole
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Federated: !Ref GitHubOIDCProviderArn
            Action: 
              - "sts:AssumeRoleWithWebIdentity"
            Condition:
              StringEquals:
                token.actions.githubusercontent.com:aud: "sts.amazonaws.com"
              StringLike:
                "token.actions.githubusercontent.com:sub": "repo:yuyacode/AppLiftCommonInfra:*"
      Policies:
        - PolicyName: "CloudFormationStackManagementPolicy"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "cloudformation:CreateStack"
                  - "cloudformation:UpdateStack"
                  - "cloudformation:DeleteStack"
                  - "cloudformation:DescribeStacks"
                  - "cloudformation:DescribeStackEvents"
                  - "cloudformation:DescribeStackResources"
                  - "cloudformation:DescribeStackDriftDetectionStatus"
                  - "cloudformation:GetTemplate"
                  - "cloudformation:GetTemplateSummary"
                  - "cloudformation:ListStackResources"
                Resource: "*"
        - PolicyName: "EC2VpcManagementPolicy"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "ec2:CreateVpc"
                  - "ec2:DeleteVpc"
                  - "ec2:ModifyVpcAttribute"
                  - "ec2:CreateTags"
                  - "ec2:DeleteTags"
                  - "ec2:DescribeVpcs"
                  - "ec2:DescribeVpcAttribute"
                  - "ec2:DescribeAccountAttributes"
                  - "ec2:DescribeTags"
                  - "ec2:DescribeAvailabilityZones"
                Resource: "*"
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W11
            reason: >
              This IAM role is assumed by GitHub Actions for infrastructure deployment using CloudFormation templates.
              The templates dynamically create and manage various AWS resources.
              Due to the dynamic and flexible nature of the deployment process, it is not feasible to predefine specific resource ARNs.
              Instead, the policy strictly limits allowed actions to the minimum set necessary for infrastructure provisioning.
          - id: W28
            reason: "Fixed role name is required so that GitHub Actions can reliably assume this IAM role using its ARN."

Outputs:
  NetworkResourceDeployRoleArn:
    Description: "ARN of the IAM Role for network resource deployment"
    Value: !GetAtt NetworkResourceDeployRole.Arn
